<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<style>
		tr.state-warn td { background: #f00; }
		tr.state-lazy  td { background: #f00; }
		tr.state-missing  td { background: #f0f; }
		#Left { float: left; }
		#Right { float: left; }
		.clear { clear: both; }
		tr.highlight td { background: #ff0 !important;}
		table td { margin: 2px; }
	</style>
	<title>untitled</title>
	<script src="http://code.jquery.com/jquery-1.4.2.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="db.js" type="text/javascript" charset="utf-8"></script>
	<script src="raphael.js" type="text/javascript" charset="utf-8"></script>
	<script src="g.raphael-min.js" type="text/javascript" charset="utf-8"></script>
	<script src="g.pie-min.js" type="text/javascript" charset="utf-8"></script>
	<script src="linq.min.js" type="text/javascript" charset="utf-8"></script>
	<script>
		var colors = { "Accepted": "#517700", "Tentative": "#e98e38", "Invited": "#0977b3", "Declined": "#69001f"};
		$(function(){
			
			var $R = new Raphael($("#C")[0], 340, 240);

			var $rl = $("#RaidList"), pie;
			$rl.empty();
			Enumerable.From(CAL_byDate).ForEach(function(x) { $("<option>" + x.Key + "</option>").attr("value", x.Key).appendTo($rl); });

			$rl.change(function(){

				var date = $rl.find(":selected").attr("value");
				var source = Enumerable.From(CAL_byDate[date]).GroupBy("$.state").Select(function(x) { return { state: x.Key(), count: Enumerable.From(x).Count() }; }).ToArray()
				var data = Enumerable.From(source).OrderBy(function(x) { return -x.count; });

				if (pie) pie.remove()
				
				function guessLabel(t)
				{
					return $(t.label[1].node).text().split(/\s+/ig)[1];
				}
				
				pie = $R.g.piechart(120, 120, 100, 
									data.Select(function(x) { return x.count; }).ToArray(),
									{
										legend: data.Select(function(x) { return "## " + x.state; }).ToArray(),
										colors: data.Select(function(x) { return colors[x.state]; }).ToArray()
									 });
				pie.hover(function ()
							{
								this.sector.stop();
								this.sector.scale(1.1, 1.1, this.cx, this.cy);

								$tbody.find("tr.highlight").removeClass("highlight");
								
								if (this.label)
								{
									this.label[0].stop();
									this.label[0].scale(1.5);
									this.label[1].attr({"font-weight": 800});
									
									$tbody.find("tr.state-" + guessLabel(this).toLowerCase()).addClass("highlight");
								}
		                },
								function ()
								{
									$tbody.find("tr.highlight").removeClass("highlight");
									this.sector.animate({scale: [1, 1, this.cx, this.cy]}, 500, "bounce");
								
									if (this.label)
									{
										this.label[0].animate({scale: 1}, 500, "bounce");
										this.label[1].attr({"font-weight": 400});
									}
								});
				
				var names = Enumerable.From(ATT_byDate[date]).Concat(Enumerable.From(CAL_byDate[date]).Select(function(x) { return x.name; })).Distinct().ToArray();
				
				var attInfo = Enumerable.From(ATT_byDate[date]).ToObject(function(v) { return v; }, function(v) { return true; });
				var calInfo = Enumerable.From(CAL_byDate[date]).ToObject(function(v) { return v.name; }, function(v) { return v; });;
				$tbody.empty();

				Enumerable.From(names).ForEach(function(x){
					var attended = !!attInfo[x];
					var invState = (calInfo[x]||{}).state;
					var calendared = invState != "Invited";
					
					var $tr = $(["<tr><td>", x, "</td><td>", attended ? "Yes" : "No", "</td><td>", invState || "-", "</td></tr>"].join(""));
					if (!calendared) $tr.addClass("state-warn");
					if (!calendared && attended) $tr.addClass("state-lazy");
					if (!attended && invState == "Accepted") $tr.addClass("state-missing");
					invState && $tr.addClass("state-" + invState.toLowerCase())
					//var tdList = $tr.find("td");
					$tbody.append($tr);
				});
				
			});
			
			var $tbody = $($("#AttendanceTable").find("tbody:first")[0]).empty();
			
			$rl.change();
		});
	</script>
</head>

<body>
	<div id="Left">
		<table id="AttendanceTable" cellpadding="0" cellspacing="0">
			<thead><tr><td>name</td><td>raid?</td><td>calendar</td></tr></thead>
			<tbody></tbody>
		</table>
	</div>
	<div id="Right">
	<select id="RaidList" style="width: 200px;"></select>
	<div id="C"></div>
</div>
<br class="clear" />
</body>
</html>
